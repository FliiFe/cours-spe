\usepackage[T1]{fontenc} 
\usepackage[utf8]{inputenc}
\usepackage[french]{babel}
\usepackage[a4paper, margin=2cm]{geometry}
\usepackage[activate={true,nocompatibility},final,kerning=true,spacing=true,factor=1100,stretch=10,shrink=10]{microtype}
\usepackage{lmodern}
% \usepackage{mlmodern}
\usepackage{amsmath}
\usepackage{bbm}
\usepackage{bm}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{gauss}
\renewcommand\colswapfromlabel[1]{#1}
\renewcommand\colswaptolabel[1]{#1}
\renewcommand\rowswapfromlabel[1]{#1}
\renewcommand\rowswaptolabel[1]{#1}
\usepackage[cal=rsfso]{mathalpha}
\usepackage{mathtools}
\usepackage{array}
\usepackage{stackengine}
\stackMath
\usepackage{centernot}
\usepackage{changepage}
\usepackage{enumitem}
\usepackage{stmaryrd}
\usepackage{xcolor}
\usepackage{mdframed}
\usepackage{etoolbox}
\usepackage{xparse}
\usepackage{tocloft}
\usepackage{parskip}
\usepackage{tikz,tkz-tab}
\usepackage{pgfplots}
\usepackage[bottom,stable]{footmisc}
\usepackage{titleps}
\ifsolo
\else
\usepackage{lastpage}
\usepackage[nohints,french]{minitoc}
\fi
\usepackage{enumitem}
\usepackage{needspace}
\usepackage[noautomatic,quiet]{imakeidx}
\usepackage[normalem]{ulem}
\usepackage[hidelinks]{hyperref}

\indexsetup{firstpagestyle=empty}
\makeindex[intoc,columns=2]%,options={-s indexstyle.ist -o build/\jobname.ind}]
\makeatletter
\def\@idxitem{\par\hangindent 0pt}
\makeatother

\AtBeginDocument{\def\labelitemi{$\bullet$}}
\setlist[itemize]{leftmargin=.5cm}
\setlist[enumerate]{leftmargin=.7cm}

\newif\ifishypconc
\ishypconcfalse
\NewDocumentCommand{\newthm}{mms}{
    \newenvironment{#1}[1][]
    {\needspace{2cm}\par\noindent\normalfont\ifstrempty{##1}{\textbf{#2.}}{\textbf{#2} (##1).}\par\nopagebreak%
    \begin{mdframed}[
        linewidth=1pt,
        linecolor=black,
        nobreak=\IfBooleanTF{#3}{true}{false},
        bottomline=false,topline=false,rightline=false,
        innerrightmargin=0pt,innertopmargin=0pt,innerbottommargin=0pt,
        innerleftmargin=1em,
        skipabove=.4\baselineskip
    ]}
    {\ifishypconc \end{adjustwidth} \fi\end{mdframed}\ishypconcfalse}
}

\theoremstyle{definition}
\newthm{thm}{Théorème}*
\newthm{thmdef}{Théorème -- Définition}*
\newthm{dfn}{Définition}
\newthm{defprop}{Définition -- Proposition}*
\newthm{lmm}{Lemme}*
\newthm{rem}{Remarque}
\newthm{res}{Résultat}*
\newthm{prop}{Proposition}*
\newthm{cor}{Corollaire}
\newthm{exo}{Exercice}
\newthm{notation}{Notation}
\newtheorem*{ex}{Exemple}
\newtheorem{csq}{Conséquence}[subsection]
\newtheorem*{csq*}{Conséquence}
\renewcommand{\thecsq}{\arabic{csq}}

\AtBeginEnvironment{thmdef}{\Needspace{5\baselineskip}}
\AtBeginEnvironment{defprop}{\Needspace{5\baselineskip}}

\renewcommand{\thesection}{\arabic{section}}
\renewcommand{\thesubsection}{\emph{\alph{subsection}})}
\renewcommand{\thesubsubsection}{\emph{\roman{subsubsection}})}


\setlength{\cftsecnumwidth}{0.6cm}
\renewcommand{\cftsecpresnum}{}
\renewcommand{\cftsecaftersnum}{}


\ifsolo
\addto\captionsfrench{
  \renewcommand{\contentsname}%
    {Plan du cours}%
}
\else
\renewcommand{\thechapter}{\Roman{chapter}}
\mtcsetoffset{minitoc}{-2em}
\renewcommand{\cftsecfont}{\small\bfseries}
\setcounter{tocdepth}{1}
\setlength{\cftchapnumwidth}{1.4cm}
\fi

\newpagestyle{main}{
  \setheadrule{1pt}
  \ifsolo\else \setfootrule{1pt}\fi
  \sethead{\thesection ~--~\textsc{\sectiontitle}}{}{Page \thepage\ifsolo\else~/~\pageref{LastPage}\fi}
  \setfoot{\ifsolo\else\textbf{Chapitre \thechapter} : \textsc{\chaptertitle}\fi}{}{}
}

\newif\ifmrmspace
\NewDocumentCommand\genmrm{O{#2}m}{
    \expandafter\NewDocumentCommand\csname#1\endcsname{m}{%
        \mrmspacetrue%
        % don't put extra space if followed by ()_^
        % to get Ker(u), Ker u, (u+id), Sp_K, ...
        \ifstrequal{##1}{(}{\mrmspacefalse}{}%
        \ifstrequal{##1}{)}{\mrmspacefalse}{}%
        \ifstrequal{##1}{_}{\mrmspacefalse}{}%
        \ifstrequal{##1}{^}{\mrmspacefalse}{}%
        \mathrm{#2}%
        \ifmrmspace\;\fi##1%
    }%
}
\genmrm{Ker}
\genmrm{dom}
\genmrm{Vect}
\genmrm{Sp}
\genmrm[Img]{Im}
\genmrm{id}
\genmrm{rg}
\genmrm{ord}
\genmrm{Tr}
\genmrm{Com}
\genmrm{Cov}
\genmrm{Conv}
\genmrm{diag}
\genmrm{Hom}
\genmrm{sh}
\genmrm{ch}
\genmrm{Aut}
\NewDocumentCommand\CPM{O{0}}{\mathcal{C}^{#1}_{{P\!M}}}
\newcommand\diff{\mathrm{d}}
\newcommand\nop{\|\hspace{-1pt}|}
\newcommand\defeq{\;\underset{\text{def}}=\;}
\newcommand\1{\mathbbm{1}}
\renewcommand\Im{\mathfrak{Im}}
\renewcommand\Re{\mathfrak{Re}}
\renewcommand\mathring[1]{\overset\circ{#1}}
\renewcommand\bar[1]{\overline{#1}}
\renewcommand\leq\leqslant
\renewcommand\epsilon\varepsilon
\renewcommand\emptyset\varnothing
\renewcommand\geq\geqslant
\newcommand\floor[1]{\left\lfloor#1\right\rfloor}
\newcommand\ceil[1]{\left\lceil#1\right\rceil}
\DeclareDocumentCommand\P{}{\mathbf P}
\DeclareDocumentCommand\R{}{\mathbf R}
\DeclareDocumentCommand\K{}{\mathbf K}
\DeclareDocumentCommand\N{}{\mathbf N}
\DeclareDocumentCommand\Z{}{\mathbf Z}
\DeclareDocumentCommand\Q{}{\mathbf Q}
\DeclareDocumentCommand\C{}{\mathbf C}
\DeclareDocumentCommand\E{}{\mathbf E}
\newcommand\indep{\protect\mathpalette{\protect\indepT}{\perp}}
\def\indepT#1#2{\mathrel{\rlap{$#1#2$}\mkern2mu{#1#2}}}
\newcommand\suit{\hookrightarrow}

\makeatletter
\newcommand*{\xnrightarrow}[2][]{%
  \ext@arrow 0359\nrightarrowfill@{#1}{#2}%
}
\newcommand*{\nrightarrowfill@}{%
    \narrowfill@\relbar\relbar\rightarrow{\not \relbar}
}
\newcommand*{\narrowfill@}[5]{%
  $\m@th\thickmuskip0mu\medmuskip\thickmuskip\thinmuskip\thickmuskip
  \relax#5#1\mkern-8mu%
  \cleaders\hbox{$#5\mkern-2mu#2\mkern-2mu$}\hfill
  \mkern-5mu %
  #4%
  \mkern-5mu %
  \cleaders\hbox{$#5\mkern-2mu#2\mkern-2mu$}\hfill
  \mkern-7mu#3$%
}
\makeatother

\newcommand{\todo}[1]{{\color{red}À faire: #1}}

\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,inner sep=2pt] (char) {#1};}~}

\newcommand{\hyp}{\circled{H}}
\newcommand{\conc}{\circled{C}}

\newcommand{\Hyp}{\ishypconctrue\begin{adjustwidth}{3em}{}~\\[.1cm] \hspace*{-3em}\hyp\hspace{1em}}
\newcommand{\Conc}{~\\[.1cm] \hspace*{-3em}\conc\hspace{1em}}
\newenvironment{concenum}{
    ~\\[0.1cm]\hspace*{-3em}\begin{tabular}{@{}lp{\textwidth-4em}} \conc & \vspace{-.45cm}
\begin{enumerate}[leftmargin=.5cm]
}
{
\end{enumerate}
\end{tabular}
}

\newcommand*{\colorboxed}{}
\def\colorboxed#1#{%
  \colorboxedAux{#1}%
}
\newcommand*{\colorboxedAux}[3]{%
  % #1: optional argument for color model
  % #2: color specification
  % #3: formula
  \begingroup
    \colorlet{cb@saved}{.}%
    \color#1{#2}%
    \boxed{%
      \color{cb@saved}%
      #3%
    }%
  \endgroup
}

\tocloftpagestyle{empty}
\pagestyle{main}

\pgfplotsset{compat=1.16}

\NewDocumentCommand\endchapter{}{%
\vfill
\[\star \qquad \quad \star \qquad \quad \star \qquad \quad \star\]
\[\star \qquad \quad \star \qquad \quad \star \qquad \quad \star \qquad \quad \star\]
\vfill
}

\newcommand\undermat[2]{%
  \makebox[0pt][l]{$\smash{\underbrace{\phantom{%
    \begin{matrix}#2\end{matrix}}}_{\text{$#1$}}}$}#2}

\newcommand{\Jr}{\underbrace{%
\addstackgap[16pt]{%
\left(\begin{array}{ccc|ccc}%
        1        &    0   &  \cdots  & \cdots & \cdots &    0   \\
        0        & \ddots &  \ddots  &        &        & \vdots \\
     \vdots      & \ddots &     1    & \ddots &        & \vdots \\
  \hline \vdots  &        &  \ddots  &  0     & \ddots & \vdots \\
     \vdots      &        &          & \ddots & \ddots &    0   \\
\undermat{r}{0   & \cdots & \cdots } & \cdots &    0   &    0   \\
\end{array}
\right)}
}_{J_r}}

